{# This extends the main control panel layout from Craft CMS, ensuring consistent page design and structure #}
{% extends "_layouts/cp.twig" %}

{# Set the page title displayed in the browser tab and Craft control panel header #}
{% set title = "Broken Links"|t('broken-links') %}

{% block content %}

{# Container for the button and loading message #}
<div class="container">
    <button id="run-crawl" class="btn">Scan Links</button>
    <div id="loading"></div>
</div>

{# Placeholder for displaying results dynamically #}
<div id="results"></div>

{# Inline CSS styles for the control panel interface #}
<style>
    body {
        font-family: 'Mulish', sans-serif;
        line-height: 1.5;
        color: #333;
        background-color: #E4ECF6;
    }

    .title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    thead {
        background-color: #f3f4f6;
    }

    th {
        text-align: left;
        padding: 10px;
        font-weight: bold;
    }

    td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    tr:hover {
        background-color: #f9fafb;
    }

    .container {
        display: flex; /* Use flexbox to arrange items in a row */
        align-items: center; /* Vertically center-align the items */
        gap: 10px; /* Add spacing between the button and the loading message */
    }

    .btn {
        background-color: #DC2625;
        color: white;
        padding: 10px 15px;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
    }

    .btn:hover {
        background-color: #b91c1c;
    }

    .action-link {
        color: #006eff;
        text-decoration: none;
    }

    .action-link:hover {
        text-decoration: underline;
    }

    #loading {
        font-size: 14px;
        color: #555;
    }
</style>

{# JavaScript logic to handle the scan request and display results #}
<script>
    document.getElementById('run-crawl').addEventListener('click', function () {
        const loading = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
    
        loading.textContent = 'Scanning... Please wait.';
    
        fetch('/brokenlinks/run-crawl')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Unknown error occurred.');
                }
    
                loading.textContent = 'Scan started. Checking for results...';
    
                pollResults(); // ✅ Start polling
            })
            .catch(error => {
                console.error('Error:', error);
                loading.textContent = 'Error starting scan.';
            });
    });
    
    function pollResults() {
        const resultsDiv = document.getElementById('results');
        const loading = document.getElementById('loading');
    
        fetch('/brokenlinks/get-results')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.length > 0) {
                    loading.textContent = '';
                    resultsDiv.innerHTML = renderResultsTable(data.data);
                } else {
                    setTimeout(pollResults, 5000); // ✅ Keep checking every 5 seconds
                }
            })
            .catch(error => {
                console.error('Error fetching results:', error);
                loading.textContent = 'Error retrieving results.';
            });
    }
    
    function renderResultsTable(links) {
        return `
            <table>
                <thead>
                    <tr>
                        <th>Broken Link</th>
                        <th>Page URL</th>
                    </tr>
                </thead>
                <tbody>
                    ${links.map(link => `
                        <tr>
                            <td><a href="${link.url}" target="_blank">${link.url}</a></td>
                            <td><a href="${link.pageUrl}" target="_blank">${link.pageUrl}</a></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
</script>

{% endblock %}
