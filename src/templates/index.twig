{# This extends the main control panel layout from Craft CMS, ensuring consistent page design and structure #}
{% extends "_layouts/cp.twig" %}

{# Set the page title displayed in the browser tab and Craft control panel header #}
{% set title = "Broken Links"|t('broken-links') %}

{% block content %}

{# Container for the button and loading message #}
<div class="container">
    <button id="run-crawl" class="btn">Scan Links</button>
    <div id="loading"></div>
</div>

{# Placeholder for displaying results dynamically #}
<div id="results"></div>

{# Inline CSS styles for the control panel interface #}
<style>
    body {
        font-family: 'Mulish', sans-serif;
        line-height: 1.5;
        color: #333;
        background-color: #E4ECF6;
    }

    .title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    thead {
        background-color: #f3f4f6;
    }

    th {
        text-align: left;
        padding: 10px;
        font-weight: bold;
    }

    td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    tr:hover {
        background-color: #f9fafb;
    }

    .container {
        display: flex; /* Use flexbox to arrange items in a row */
        align-items: center; /* Vertically center-align the items */
        gap: 10px; /* Add spacing between the button and the loading message */
    }

    .btn {
        background-color: #DC2625;
        color: white;
        padding: 10px 15px;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
    }

    .btn:hover {
        background-color: #b91c1c;
    }

    .action-link {
        color: #006eff;
        text-decoration: none;
    }

    .action-link:hover {
        text-decoration: underline;
    }

    #loading {
        font-size: 14px;
        color: #555;
    }
</style>

{# JavaScript logic to handle the scan request and display results #}
<script>
    document.getElementById('run-crawl').addEventListener('click', function () {
        const loading = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
    
        // Show a loading message while the scan runs
        loading.textContent = 'Scanning... Please wait.';
        resultsDiv.innerHTML = '';
    
        // Start the scan
        fetch('/brokenlinks/run-crawl')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message);
                }
    
                const jobId = data.jobId;
                checkQueueStatus(jobId);
            })
            .catch(error => {
                console.error('Error:', error);
                resultsDiv.innerHTML = `<p>Error: ${error.message}</p>`;
                loading.textContent = ''; // Clear loading message
            });
    });
    
    /**
     * Check the status of the queue job and fetch results when done.
     */
    function checkQueueStatus(jobId) {
        fetch('/admin/utils/queue')
            .then(response => response.text())
            .then(text => {
                if (text.includes(jobId)) {
                    setTimeout(() => checkQueueStatus(jobId), 3000); // Check again in 3s
                } else {
                    fetchResults();
                }
            })
            .catch(error => {
                console.error('Queue check error:', error);
            });
    }
    
    /**
     * Fetch broken links once the job completes.
     */
    function fetchResults() {
        fetch('/brokenlinks/get-results')
            .then(response => response.json())
            .then(data => {
                const resultsDiv = document.getElementById('results');
                const loading = document.getElementById('loading');
    
                loading.textContent = '';
    
                if (!data.success || data.data.length === 0) {
                    resultsDiv.innerHTML = '<p>No broken links found.</p>';
                    return;
                }
    
                // Create table with results
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Broken Link</th>
                            <th>Field</th>
                            <th>Page URL</th>
                            <th>Entry</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data
                            .map(
                                link => `
                            <tr>
                                <td><a href="${link.url}" target="_blank">${link.url}</a></td>
                                <td>${link.field || 'N/A'}</td>
                                <td><a href="${link.pageUrl}" target="_blank">${link.pageUrl}</a></td>
                                <td>
                                    ${
                                        link.entryUrl
                                            ? `<a href="${link.entryUrl}" target="_blank">${link.entryTitle || 'N/A'}</a>`
                                            : 'N/A'
                                    }
                                </td>
                            </tr>
                        `
                            )
                            .join('')}
                    </tbody>
                `;
                resultsDiv.appendChild(table);
            })
            .catch(error => {
                console.error('Fetch results error:', error);
                resultsDiv.innerHTML = `<p>Error fetching results.</p>`;
            });
    }    
</script>

{% endblock %}
